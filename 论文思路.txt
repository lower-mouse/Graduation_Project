
第一章：绪论
1.1 课题的研究背景和意义
1.2 国内外研究的现状
1.3 本文研究的创新点
1.4 论文的组织架构

第二章：物联网技术的研究
2.1 常用的物联网技术
2.2 NB-IoT
2.3 本章小结

第三章：NB-IoT 与云端的通讯
3.1 云端的优势
3.2 ocean cloud简介
3.3 NB-IoT与云端的通讯策论
3.4 ocean cloud profile开发
3.5 ocean cloud 插件开发
3.6 本章小结

第四章：终端设备方案
3.1 MCU模块设计
3.2 NB-IoT模块设计
3.3 显示模块设计
3.4 阀门控制模块设计
3.5 水流量计量模块设计
3.6 电源模块设计
3.7 电源管理
3.8 系统硬件框架设计
3.9 系统软件框架设计
3.10 本章小结

第五章：功能测试
5.1 终端设备低功耗测试
5.2 NB-IoT通讯功能测试
5.3 显示模块测试
5.4 低电量环境测试
5.5 本章小结

第六章：总结与展望
6.1 总结
6.2 展望

参考文献
附录一
附录二








第二章：物联网技术的研究

2.1 常用的物联网技术
现在物联网的通讯方式主要是采用无线通讯的方式，在无线通讯中通讯距离分为两种，一种是短距离的

ZigBee，蓝牙，WIFI，还有就是长距离的LoRa, NB-IoT

2.1.1 LoRa技术  http://www.c114.com.cn/m2m/2493/a964619.html

LoRa与NB-IoT是最有发展前景的两个低功耗广域网通信技术。不过两者之间到底有什么区别和不同？谁

又将更胜一筹占领LPWAN制高点？

物联网的快速发展对无线通信技术提出了更高的要求，专为低带宽、低功耗、远距离、大量连接的物联

网应用而设计的LPWAN（low-power Wide-Area Network，低功耗广域网）也快速兴起。NB-IoT与LoRa是

其中的典型代表，也是最有发展前景的两个低功耗广域网通信技术。

这两种LPWAN技术都有覆盖广、连接多、速率低、成本低、功耗少等特点，都适合低功耗物联网应用，都

在积极扩建自己的生态系统。

LoRa的诞生比NB-IoT要早些，2013年8月，Semtech公司向业界发布了一种新型的基于1GHz以下的超长距

低功耗数据传输技术（Long Range，简称LoRa）的芯片。其接受灵敏度达到了惊人的-148dbm，与业界其

他先进水平的sub-GHz芯片相比，最高的接收灵敏度改善了20db以上，这确保了网络连接可靠性。

它使用线性调频扩频调制技术，即保持了像FSK（频移键控）调制相同的低功耗特性，又明显地增加了通

信距离，同时提高了网络效率并消除了干扰，即不同扩频序列的终端即使使用相同的频率同时发送也不

会相互干扰，因此在此基础上研发的集中器/网关（Concentrator/Gateway）能够并行接收并处理多个节

点的数据，大大扩展了系统容量

线性扩频已在军事和空间通信领域使用了数十年，因为其可以实现长通信距离和干扰的鲁棒性，而LoRa

是第一个用于商业用途的低成本实现。随着LoRa的引入，嵌入式无线通信领域的局面发生了彻底的改变

。这一技术改变了以往关于传输距离与功耗的折衷考虑方式，提供一种简单的能实现远距离、长电池寿

命、大容量、低成本的通讯系统

LoRa主要在全球免费频段运行（即非授权频段），包括433、868、915 MHz等。LoRa网络主要由终端（内

置LoRa模块）、网关（或称基站）、服务器和云四部分组成，应用数据可双向传输。

2.1.2 ZigBee技术
ZigBee技术是一种近距离、低复杂度、低功耗、低速率、低成本的双向无线通讯技术。主要用于距离短

、功耗低且传输速率不高的各种电子设备之间进行数据传输以及典型的有周期性数据、间歇性数据和低

反应时间数据传输的应用。自从马可尼发明无线电以来，无线通信技术一直向着不断提高数据速率和传

输距离的方向发展。例如：广域网范围内的第三代移动通信网络（3G）目的在于提供多媒体无线服务，

局域网范围内的标准从IEEE802.11的1Mbit/s到IEEE802.11g的54Mbit/s的数据速率。而当前得到广泛研

究的ZigBee技术则致力于提供一种廉价的固定、便携或者移动设备使用的极低复杂度、成本和功耗的低

速率无线通信技术。这种无线通信技术具有如下特点：

????? 功耗低：工作模式情况下，ZigBee技术传输速率低，传输数据量很小，因此信号的收发时间很短

，其次在非工作模式时，ZigBee节点处于休眠模式。设备搜索时延一般为30ms，休眠激活时延为15ms，

活动设备信道接入时延为15ms。由于工作时间较短、收发信息功耗较低且采用了休眠模式，使得ZigBee

节点非常省电，ZigBee节点的电池工作时间可以长达6个月到2年左右。同时，由于电池时间取决于很多

因素，例如：电池种类、容量和应用场合，ZigBee技术在协议上对电池使用也作了优化。对于典型应用

，碱性电池可以使用数年，对于某些工作时间和总时间（工作时间+休眠时间）之比小于1%的情况，电池

的寿命甚至可以超过10年。

????? 数据传输可靠：ZigBee的媒体接入控制层（MAC层）采用talk-when-ready的碰撞避免机制。在这

种完全确认的数据传输机制下，当有数据传送需求时则立刻传送，发送的每个数据包都必须等待接收方

的确认信息，并进行确认信息回复，若没有得到确认信息的回复就表示发生了碰撞，将再传一次，采用

这种方法可以提高系统信息传输的可靠性。同时为需要固定带宽的通信业务预留了专用时隙，避免了发

送数据时的竞争和冲突。同时ZigBee针对时延敏感的应用做了优化，通信时延和休眠状态激活的时延都

非常短。

????? 网络容量大：ZigBee低速率、低功耗和短距离传输的特点使它非常适宜支持简单器件。ZigBee定

义了两种器件：全功能器件（FFD）和简化功能器件（RFD）。对全功能器件，要求它支持所有的49个基

本参数。而对简化功能器件，在最小配置时只要求它支持38个基本参数。一个全功能器件可以与简化功

能器件和其他全功能器件通话，可以按3种方式工作，分别为：个域网协调器、协调器或器件。而简化功

能器件只能与全功能器件通话，仅用于非常简单的应用。一个ZigBee的网络最多包括有255个ZigBee网路

节点，其中一个是主控（Master）设备，其余则是从属（Slave）设备。若是通过网络协调器（Network 

Coordinator），整个网络最多可以支持超过64000个ZigBee网路节点，再加上各个Network Coordinator

可互相连接，整个ZigBee网络节点的数目将十分可观。

????? 兼容性：ZigBee技术与现有的控制网络标准无缝集成。通过网络协调器（Coordinator）自动建立

网络，采用载波侦听/冲突检测（CSMA-CA）方式进行信道接入。为了可靠传递，还提供全握手协议。

????? 安全性：Zigbee提供了数据完整性检查和鉴权功能，在数据传输中提供了三级安全性。第一级实

际是无安全方式，对于某种应用，如果安全并不重要或者上层已经提供足够的安全保护，器件就可以选

择这种方式来转移数据。对于第二级安全级别，器件可以使用接入控制清单（ACL）来防止非法器件获取

数据，在这一级不采取加密措施。第三级安全级别在数据转移中采用属于高级加密标准（AES）的对称密

码。AES可以用来保护数据净荷和防止攻击者冒充合法器件，各个应用可以灵活确定其安全属性。

????? 实现成本低：模块的初始成本估计在6美元左右，很快就能降到1.5-2.5美元，且Zigbee协议免专

利费用。目前低速低功率的UWB芯片组的价格至少为20美元。而ZigBee的价格目标仅为几美分。低成本对

于ZigBee也是一个关键的因素。

　　时延短： 通信时延和从休眠状态激活的时延都非常短，典型的搜索设备时延30ms,休眠激活的时延

是15ms, 活动设备信道接入的时延为15ms。因此ZigBee技术适用于对时延要求苛刻的无线控制（如工业

控制场合等）应用。


2.1.3 蓝牙BLE
BLE（Bluetooh Low Energy）蓝牙低能耗技术是短距离、低成本、可互操作性的无线技术，它利用许多

智能手段最大限度地降低功耗。
蓝牙通讯技术与WiFi无线网络技术相比，蓝牙通讯技术应用于各种设备上有 省电、传输稳定、小巧、安

全方面等优势。

在智能家居设备系统中，传统的家居电气设备都是可以连入局域网方便同时交互和控制，但是大多数的

智能设备并不适合很高的带宽、相比较于功耗高的WiFi通讯技术接入方式，智能LED灯、智能开关、智能

插座、空调、厨卫电器、净化/加湿设备等这些设备就更适合使用蓝牙传输。而且只需一个蓝牙设备就能

控制所有智能家居，所有的智能家居系统内的电器就可以抛弃较为复杂的WiFi连接，改用轻便小巧功耗

低的蓝牙通讯协议传输。


2.1.4 wifi

2.1.5 物联网通讯方式比较


2.2 NB-IoT技术
2.2.1 NB-IoT技术的特点
 强链接：在同一基站的情况下，NB-IoT可以比现有无线技术提供50-100倍的接入数。一个扇区能够支持

10万个连接，支持低延时敏感度、超低的设备成本、低设备功耗和优化的网络架构。举例来说，受限于

带宽，运营商给家庭中每个路由器仅开放8-16个接入口，而一个家庭中往往有多部手机、笔记本、平板

电脑，未来要想实现全屋智能、上百种传感设备需要联网就成了一个棘手的难题。而NB-IoT足以轻松满

足未来智慧家庭中大量设备联网需求。

 高覆盖：NB-IoT室内覆盖能力强，比LTE提升20dB增益，相当于提升了100倍覆盖区域能力。不仅可以满

足农村这样的广覆盖需求，对于厂区、地下车库、井盖这类对深度覆盖有要求的应用同样适用。以井盖

监测为例，过去GPRS的方式需要伸出一根天线，车辆来往极易损坏，而NB-IoT只要部署得当，就可以很

好的解决这一难题。

低功耗：低功耗特性是物联网应用一项重要指标，特别对于一些不能经常更换电池的设备和场合，如安

置于高山荒野偏远地区中的各类传感监测设备，它们不可能像智能手机一天一充电，长达几年的电池使

用寿命是最本质的需求。NB-IoT聚焦小数据量、小速率应用，因此NB-IoT设备功耗可以做到非常小，设

备续航时间可以从过去的几个月大幅提升到几年。
低成本：与LoRa相比，NB-IoT无需重新建网，射频和天线基本上都是复用的。以中国移动为例，900MHZ

里面有一个比较宽的频带，只需要清出来一部分2G的频段，就可以直接进行LTE和NB-IoT的同时部署。低

速率、低功耗、低带宽同样给NB-IoT芯片以及模块带来低成本优势。模块预期价格不超过5美元。
不过，NB-IoT仍有着自身的局限性。在成本方面，NB-IoT模组成本未来有望降至5美元之内，但目前支持

蓝牙、Thread、ZigBee三种标准的芯片价格仅在2美元左右，仅支持其中一种标准的芯片价格不到1美元

。巨大的价格差距无疑将让企业部署NB-IoT产生顾虑。

2.2.2 NB-IoT的低功耗实现

低功耗是NB-IoT技术的最重要特点之一，那它的低功耗是怎么实现的呢？--PSM、eDRX就是实现NB-IoT低

功耗的左膀右臂

PSM（Power Saving Mode）
PSM即低功耗模式，是3GPP R12引入的技术，其原理是允许UE在进入空闲状态一段时间后，关闭信号的收

发和AS（接入层）相关功能，相当于部分关机，从而减少天线、射频、信令处理等功耗消耗

UE在PSM期间，不接收任何网络寻呼，对于网络侧来说，UE此时是不可达的，数据、短信、电话均进不来

。只有当TAU周期请求定时器（T3412）超时，或者UE有MO业务要处理而主动退出时，UE才会退出PSM模式

、进入空闲态，进而进入连接态处理上下行业务。
TAU周期请求定时器（T3412）由网络侧在ATTCH和TAU消息中指定，3GPP协议规定默认为54min，最大可达

310H。
那么UE处理完数据之后，什么时候进入PSM模式呢？这是由另一个定时器Activer Timer(T3324，0-255秒

)决定的。UE处理完成数据之后，RRC连接会被释放、进入空闲态，与此同时启动Active Timer，此Timer

超时后，UE即进入上述PSM模式。转换状态如下（借图）：


eDRX（Extended DiscontinuousReception)

eDRX即非连续接收，是3GPP R13引入的新技术。R13之前已经有DRX技术，从字面上即可看出，eDRX是对

原DRX技术的增强：支持的寻呼周期可以更长，从而达到节电目的。继续借图：

 

 

eDRX的寻呼周期由网络侧在ATTACH和TAU消息中指定（UE可以指定建议值），可为20s，40s，80s，…最

大可达40min。相比以往1.28s/2.56s等DRX寻呼周期配置，eDRX耗电量显然低很多。

 

PSM和eDRX虽然让终端耗电量大大降低，但都是通过长时间的“罢工”来换取的，付出了实时性的代价。

对于有远程不定期监控（如远程定位，电话呼入，配置管理等）需求且实时性要求很高的场景，不适合

开启PSM功能；如果允许一定的时延，最好采用eDRX技术、并将eDRX寻呼周期设的尽量短些（根据可接受

的时延要求，最短为20s，…）。UE可在ATTACH和TAU中请求开启PSM或（和）eDRX，但最终开启哪一种或

两种均开启、以及周期是多少均由网络侧决定。
2.3 本章小结


第三章：NB-IoT 与云端的通讯
3.1 NB-IoT与应用的交互
过程，为什么
终端设备采集的数据，通过NB-IoT模组将数据上传到服务器，




3.2 OceanConnect IoT简介
1） 应用预集成的解决方案与生态链构建：以基于云化的IoT联接管理平台为核心，同时支持公有云和私

有云部署，面向企业/行业，家庭/个人领域提供一系列的预集成应用，包括智慧家庭、车联网、公共事

业、油气能源等；华为立足于构建一个与合作伙伴共赢的生态链，越来越多的应用正在加入华为物联网

平台，共同构建一个智能的全连接世界，创造更大的商业价值。

2） 接入无关（任意设备、任意网络、多协议适配）：支持无线、有线等多种网络连接方式接入，可以

同时接入固定，移动（2G/3G/4G/NB IoT）；丰富的协议适配能力，支持海量多样化终端设备接入；

Agent方案简化了各类终端厂家的开发，屏蔽各种复杂设备接口，实现终端设备的快速接入；同时华为可

以提供预集成Agent的室内外物联网敏捷网关，真正做到给客户提供端到端的物联网基础平台，让客户聚

焦于自身的业务；华为平台帮助客户实现了应用与终端的解耦合，帮助客户不再受限于私有协议对接，

获得灵活的分批建设系统的自由。

3） 强大的开放与集成能力：网络API、安全API、数据API三大类API，帮助行业集成商和开发者实现强

大的联接安全，数据的按需获取和个性化的用户体验；华为IoT联接管理平台的集成框架安全、可靠，可

以实现与现网网元、IT系统的快速集成；华为的生态构建支持，可以给各位应用厂商提供零成本的云调

试对接环境，快速体验华为API并完成新产品的集成。

4） 大数据分析与实时智能：实现了云端平台、边缘网关、智能终端的分层智能与控制。提供规则引擎

等智能分析工具。

5） 支持全球主流IoT标准: 华为IoT联接管理平台支持全球主流IoT标准协议及功能实现，包括权威平台

规范oneM2M、ETSI等。在家庭网络领域，遵循了ZWave/ZigBee/BlueTooth/Allseen/Thread等标准，同时

华为推出了Hi-Link家庭网络标准。在车联网领域，遵循了JT/T 808等标准规范


3.4 profile开发


3.5 插件开发


3.6 本章小结


第四章：终端设备方案
3.1 MCU模块设计
为了满足智能水表系统低功耗设计的需求，所以我们需要采用支持满足低功耗需求的MCU
主流低功耗MCu研究




3.2 NB-IoT模块设计
NB-IoT的使用还是很方便的，MCU通过UART发送AT指令就可以控制BC95模组了，不过想要把数据发送到目标服务器还是要对BC95模块做一些配置的，首先就是要把BC95模块附着到网络，成功附着到网络之后，再配置我们的目标服务器和端口号，实现数据的交互了。我们选择的云平台是华为的ocean connect，成功注册之后，账号和密码会通过邮件发动到你的邮箱，登陆上ocean connect之后，我们并不能看到我们设备上传的数据，因为我们需要在平台上注册我们的设备，每一个NB-IoT的设备都有一个唯一的身份标识，通过AT指令(AT+CIMI)我们就可以获取到。但是我们注册的是一个什么类型的设备呢，它又有一些什么样的特性呢，我们需要在ocean connect上开发一个profile和插件，profile规定了我们设备和平台的通讯协议，插件控制我们上传的数据流向和命令的响应，也会过滤掉无关的数据

3.3 显示模块设计
显示模块采用的是段式LCD显示屏，当然我们选择的理由无非就极低的功耗和低廉的成本，再加上MCU上集成了这种显示屏的驱动器，我们只需要简单的配置一些相应的寄存器，就可以使用这个显示屏了，在MCU的寄存器中有一组寄存器是对应LCD显示的，寄存器中的每一位，都对应着显示屏上的一个像素点，这样我们就可以通过程序，让LCD显示出所期待的图案，
3.4 阀门控制模块设计
3.5 水流量计量模块设计
水流量的计量所采用的是双干簧管传感器，利用磁铁的磁力使干簧管，的簧片循环吸合开断，从而输出计量脉冲信号。在水表实际的使用之中，我们常常会碰到这样的情况：当水管中进入一定量的空气时，水管就会不停的震动，此时磁钢与干簧管的位置刚好处于临建状态，就会不停地将脉冲信号发送给CPU，使得CPU无法正确的计数，为了防止此类问题的发生，双干簧管就可以很好地解决，当一个收发一个干簧管的脉冲时，在程序中会先判断一个标志位，若没有置位便将其置位，如没有收到下一个干簧管的脉冲，这个位将不会被清除。
3.6 电源模块设计
3.7 电源管理
  电源管理的目的是保证设备在电源异常的情况下，设备不会出现超出程序预期的现象，而且在重新上电时要保证数据的正常，为了实现这个需求，我们在电池电量低于2.9V时，我们会通过NB-IoT模块将低电量的信息上报，提醒用户及时更换电池，在电池电量低于2.7V时，设备会启动关机任务，将用户数据保存，关闭阀门，上报信息。为了防止故意断电导致设备异常的情况发生，在我们会焊接一个大的电容上去，保证在意外断电时，可以完成关机任务。
3.8 系统硬件框架设计
3.9 系统软件框架设计
需求：为了满足智能水表的

软件设计分为系统检测任务和数据交互任务两个部分，
系统检测任务是整个系统的重要组成部分。为了满足功耗需求，系统加测任务一秒钟启动一次，通过MCU的RTC模块控制，系统唤醒后干簧管模块采水流量的数据，AD模块每30秒检测一次电源电压，若电压低于设点值，将会触发系统的报警策略，再就是检测用户的余额是否充足，若余额低于一个设定值，我们会将一个报警信息发送到云端，若低于0就会关闭阀门，阀门的开关用的是异步的方式去操作它，一秒钟检测一次阀门位置是否到达极限的位置，若是到达了，才会去关闭阀门驱动的电源
数据交互程序又分为控制命令和透传数据两种，MCU通过控制命令BC95模组的状态和控制BC95模块，透传的数据通过NB模块直接上传到云平台，但是上传数据也有一些需要注意的地方，比如我们传的数据必须是十六进制的而且要转换成十六进制的，收到的数据也是这样的格式，还有字节序，MCU的字节序是小端而云平台是大端的，若不注意数据解析就会出现问题，数据的范围最好不要超过profile文件中的限制，因为平台会帮你过滤这些不符合规定的数据。云平台下发的数据会通过模块发送给MCU，通过是否是+NNMI开头来断定是否是来自平台的数据，并且每个命令的数据格式都是不同的，所以需要不同函数来解析和响应这些命令
3.10 本章小结

第五章：功能测试
5.1 终端设备低功耗测试
5.2 NB-IoT通讯功能测试
5.3 显示模块测试
5.4 低电量环境测试
5.5 本章小结
